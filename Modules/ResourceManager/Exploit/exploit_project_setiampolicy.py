from Modules.ResourceManager.utils.util_helpers import *

# Entrypoint
def run_module(user_args, session, first_run = False, last_run = False):
    
    # Set up Argparser to handle flag arguments
    parser = argparse.ArgumentParser(description="Set the IAM Policy for a Given Project", allow_abbrev=False)
    
    # Debug/non-module specific
    parser.add_argument("-v","--debug",action="store_true",required=False,help="Get verbose data during the module run")
    
    # Module specific arguments
    parser.add_argument("--project-name", type=str, required=False,  help="Project system name (not user-assigned common name or project id) ex: projects/ID")
    parser.add_argument("--member", type=str, required=False,  help="User to add, not supplying will default to current email; format user:[email] or serviceAccount:[serviceemail].")
    
    exclusive_group = parser.add_mutually_exclusive_group(required=False)
    exclusive_group.add_argument("--default-role", action="store_true", help="Attach the default role; roles/owner")
    exclusive_group.add_argument("--role", type=str, required=False,  help="Role to bind the member to on the folder resource")

    parser.add_argument("--brute", action="store_true", required=False,  help="If the current policy cannot be gathered and appended to, rewrite entire IAM policy with just your member")

    args = parser.parse_args(user_args)

    debug = args.debug

    project_client = resourcemanager_v3.ProjectsClient(credentials=session.credentials)

    project_name, member, role = None, None, None

    if args.project_name:
        project_name = args.project_name

    if args.member:
        member = args.member

    if args.role:
        role = args.role

    if not project_name:
        rows_returned = session.get_data("abstract-tree-hierarchy", columns = ["name", "display_name","project_id"], conditions = "type=\"project\"")
        if len(rows_returned) == 0:
            print("[X] No projects found. Try rerunning module with with specified resource via --project-name ")
            return -1
        
        for row in rows_returned:
            name, display_name, project_id = row["name"], row["display_name"], row["project_id"]
            row["display_to_user"] = f"{name} (Project ID: {project_id}; Common Name: {display_name})"

        # Return dictionary corresponding to user choice
        project_dict = session.choice_selector(rows_returned,"Choose an existing organization from below to set the IAM policy:", fields=["display_to_user"])
        if not project_dict:
            print("[X] Exiting the current module...")
            return -1        

        # Project ID could be "Unknown"
        project_name = project_dict["name"]
        project_display_name = project_dict["display_name"]
        project_id = project_dict["project_id"]

    if not member:
        member = session.choose_member()
        if not member:
            print("Exiting...")
            return -1

    if not role:
        default_role = "roles/owner"
        allowed_project_roles_menu = [
            f"{default_role} (Default)",
            "roles/editor",
            "roles/viewer",
            "roles/resourcemanager.projectIamAdmin",
            "roles/resourcemanager.projectCreator"
        ]
        role = session.choose_role(allowed_project_roles_menu, chosen_role = args.role, default_role = default_role)
        if not role:
            return -1

    if debug:
        print(f"[DEBUG] Proceeding with:\n  Project:{project_name}\n")
        print(f"[DEBUG] Proceeding with member: {member}")
        print(f"[DEBUG] Proceeding with role: {role}")

    print(f"[*] Binding Member {member} on {project_name} to role {role}")

    # Note project ID needs to exist to save perm
    if project_id:
        action_dict = {}

    status = add_project_iam_member(project_client, project_name, member, action_dict, brute = args.brute, role = role, debug=debug)

    if status:
        print(f"[*] Successfully added {member} to the policy of function {project_name}")
            
    if action_dict: session.insert_actions(action_dict, project_id) 